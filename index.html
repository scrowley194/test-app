<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Coach Lite</title>

<!-- iOS PWA hooks -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png" />
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#0a0f1a" />

<style>
  :root{
    --bg:#070b14; --bg2:#0e1526;
    --card:#111a2d; --edge:rgba(255,255,255,.08);
    --text:#eef3fb; --muted:#96a3b6;
    --mint:#6ee7b7; --sky:#93c5fd; --rose:#fda4af; --amber:#fde68a;
    --r:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 800px at 120% -10%, #1a2440 0%, var(--bg) 60%),
      linear-gradient(180deg, var(--bg2), var(--bg));
    font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }

  /* App shell */
  .app{position:relative; min-height:100dvh; padding-bottom:76px}
  .header{
    position:sticky; top:0; z-index:10; backdrop-filter:blur(10px);
    background:linear-gradient(180deg, rgba(14,21,38,.84), rgba(14,21,38,.55));
    border-bottom:1px solid var(--edge); padding:14px 16px 12px; display:flex; justify-content:space-between; align-items:flex-end;
  }
  .brand{
    background:linear-gradient(90deg, #fff, #cbe0ff 45%, #a2ffd8 85%);
    -webkit-background-clip:text; background-clip:text; color:transparent; font-size:22px; font-weight:800; letter-spacing:.3px;
  }
  .today{color:var(--muted); font-size:12px}

  /* Views */
  .view{position:absolute; inset:54px 0 76px; padding:14px 14px 24px; overflow:auto; transform:translateX(100%); transition:transform .25s ease; will-change:transform}
  .view.active{transform:translateX(0)}
  .view.left{transform:translateX(-100%)}
  .cards{display:grid; gap:12px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
    border:1px solid var(--edge); border-radius:var(--r); padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.35); backdrop-filter:blur(6px)
  }

  /* Inputs + buttons */
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  input, select{
    width:100%; background:#0c1426; color:var(--text); border:1px solid var(--edge); border-radius:12px; padding:12px 12px; font-size:16px
  }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    appearance:none; border:1px solid var(--edge); border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    padding:12px 14px; font-weight:600; color:var(--text); box-shadow:0 6px 16px rgba(0,0,0,.25); transition:transform .14s ease
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{border-color:rgba(110,231,183,.45); background:linear-gradient(180deg, rgba(110,231,183,.28), rgba(110,231,183,.12))}
  .btn.warn{border-color:rgba(253,230,138,.45); background:linear-gradient(180deg, rgba(253,230,138,.28), rgba(253,230,138,.12))}
  .btn.ghost{background:transparent}

  .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--edge); color:var(--muted)}
  .muted{color:var(--muted)}

  /* Exercise cards */
  .ex{
    display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center;
    padding:12px; border-radius:16px; border:1px solid var(--edge); background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01))
  }
  .ico{
    width:54px; height:54px; border-radius:14px; display:grid; place-items:center;
    background:radial-gradient(circle at 30% 30%, rgba(147,197,253,.35), transparent 60%), radial-gradient(circle at 70% 60%, rgba(110,231,183,.35), transparent 60%);
  }
  .ex h3{margin:0; font-size:16px}
  .tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:4px}
  .tag{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--edge); color:var(--muted)}

  /* Workout runner full screen */
  .runner{
    position:fixed; inset:0; z-index:999; display:none; background:linear-gradient(180deg, #0a0f1a, #0c1324);
  }
  .runner.show{display:block}
  .run-head{display:flex; justify-content:space-between; align-items:center; padding:16px; border-bottom:1px solid var(--edge); backdrop-filter:blur(10px)}
  .run-name{font-size:18px; font-weight:800}
  .ring{
    margin:22px auto 8px; width:220px; height:220px; position:relative
  }
  .ring svg{width:100%; height:100%; transform:rotate(-90deg)}
  .ring .time{position:absolute; inset:0; display:grid; place-items:center; font-size:34px; font-weight:800; letter-spacing:.8px}
  .run-ctrl{display:flex; gap:10px; justify-content:center; padding:8px 16px 18px}
  .setlist{padding:0 16px 24px; display:grid; gap:10px}
  .setrow{display:flex; gap:8px; align-items:center}
  .setrow input{width:90px}
  .foot-note{color:var(--muted); text-align:center; font-size:12px}

  /* Bottom nav */
  .nav{
    position:fixed; bottom:0; left:0; right:0; height:76px; z-index:15;
    border-top:1px solid var(--edge); background:linear-gradient(180deg, rgba(12,19,38,.75), rgba(12,19,38,.95)); backdrop-filter:blur(10px);
    display:flex; justify-content:space-around; align-items:center; padding:8px 12px
  }
  .nav .tab{flex:1; text-align:center; color:var(--muted)}
  .nav .tab.active{color:var(--text)}
  .nav .tab svg{display:block; margin:0 auto 2px}
  .fab{
    position:fixed; right:18px; bottom:90px; width:62px; height:62px; border-radius:50%;
    display:grid; place-items:center; background:linear-gradient(180deg, rgba(110,231,183,.3), rgba(110,231,183,.14));
    border:1px solid rgba(110,231,183,.45); box-shadow:0 10px 24px rgba(0,0,0,.35)
  }

  /* Decorative grid background */
  .bg{position:fixed; inset:0; pointer-events:none; z-index:-1}
  canvas{display:block; width:100%; height:100%}
  @media (prefers-reduced-motion: reduce){ *{transition:none !important; animation:none !important} }
</style>
</head>
<body>
<div class="bg"><canvas id="bg"></canvas></div>

<div class="app" id="app">
  <div class="header">
    <div>
      <div class="brand">Coach Lite</div>
      <div class="today" id="today"></div>
    </div>
    <button class="btn ghost" id="exportBtn">Export</button>
  </div>

  <!-- Views -->
  <main class="view active" id="view-plan" aria-label="Plan view">
    <div class="cards">
      <div class="card">
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
          <strong>Setup</strong>
          <span class="pill" id="estTime">0 minutes</span>
        </div>
        <div class="row" style="gap:12px">
          <div style="flex:1">
            <label>Goal</label>
            <select id="goal">
              <option value="strength">Strength</option>
              <option value="hypertrophy" selected>Hypertrophy</option>
              <option value="fatloss">Conditioning</option>
            </select>
          </div>
          <div style="width:120px">
            <label>Minutes</label>
            <input id="minutes" type="number" min="15" step="5" value="45" />
          </div>
        </div>
        <div class="row" style="gap:12px; margin-top:10px">
          <div style="flex:1">
            <label>Split</label>
            <select id="split">
              <option value="full">Full body</option>
              <option value="push" selected>Push</option>
              <option value="pull">Pull</option>
              <option value="legs">Legs</option>
              <option value="upper">Upper</option>
              <option value="lower">Lower</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Equipment</label>
            <select id="equipment">
              <option value="full" selected>Full gym</option>
              <option value="dumbbells">Dumbbells + bench</option>
              <option value="home">Bodyweight + bands</option>
            </select>
          </div>
          <div style="width:150px">
            <label>Experience</label>
            <select id="level">
              <option value="new">New</option>
              <option value="intermediate" selected>Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="buildBtn">Build session</button>
          <button class="btn" id="quickBtn">Quick start</button>
        </div>
      </div>

      <div class="card">
        <strong>Todayâ€™s session</strong>
        <div id="planList" class="cards" style="margin-top:10px"></div>
        <div class="row" style="margin-top:12px; justify-content:space-between">
          <button class="btn" id="shuffleBtn">Shuffle</button>
          <button class="btn warn" id="startBtn">Start workout</button>
        </div>
      </div>
    </div>
  </main>

  <section class="view" id="view-workout" aria-label="Workout history view">
    <div class="cards">
      <div class="card">
        <strong>Progress</strong>
        <canvas id="chart" width="720" height="160" style="margin-top:8px"></canvas>
        <div class="foot-note" id="prs"></div>
      </div>
      <div class="card">
        <strong>Recent sessions</strong>
        <div id="history" class="cards" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <section class="view" id="view-settings" aria-label="Settings view">
    <div class="cards">
      <div class="card">
        <strong>Cache and data</strong>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="resetToday">Reset today</button>
          <button class="btn" id="clearAll">Clear all data</button>
        </div>
        <p class="muted" style="margin-top:6px">Tip: after an update, refresh with <code>?v=6</code> to bypass cache.</p>
      </div>
      <div class="card">
        <strong>About</strong>
        <p class="muted" style="margin:6px 0 0">Made for fast, offline training sessions. No accounts. Everything stays on your device.</p>
      </div>
    </div>
  </section>

  <!-- Runner overlay -->
  <aside class="runner" id="runner" aria-live="polite">
    <div class="run-head">
      <div class="run-name" id="runName">Exercise</div>
      <button class="btn" id="closeRun">Close</button>
    </div>
    <div class="ring">
      <svg viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="54" stroke="rgba(255,255,255,.08)" stroke-width="10" fill="none" />
        <circle id="ringProg" cx="60" cy="60" r="54" stroke="url(#g)" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="339.292" stroke-dashoffset="0"/>
        <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0%" stop-color="#93c5fd"/><stop offset="100%" stop-color="#6ee7b7"/></linearGradient></defs>
      </svg>
      <div class="time" id="timeText">00:60</div>
    </div>
    <div class="run-ctrl">
      <button class="btn primary" id="startRest">Start rest</button>
      <button class="btn" id="pauseRest">Pause</button>
      <button class="btn" id="resetRest">Reset</button>
      <span class="pill">Rest <input id="restLen" type="number" value="60" min="10" style="width:84px" /></span>
    </div>
    <div class="setlist" id="setList"></div>
    <p class="foot-note">Haptics on mark done. Swipe down or tap Close to exit.</p>
  </aside>

  <!-- Bottom navigation -->
  <nav class="nav">
    <div class="tab active" data-to="view-plan">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Plan
    </div>
    <div class="tab" data-to="view-workout">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M4 18v-6a8 8 0 1 1 16 0v6" stroke="currentColor" stroke-width="2"/><path d="M8 22h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Progress
    </div>
    <div class="tab" data-to="view-settings">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 3v3M12 18v3M3 12h3M18 12h3M5.6 5.6l2.1 2.1M16.3 16.3l2.1 2.1M18.4 5.6l-2.1 2.1M7.7 16.3l-2.1 2.1" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/></svg>
      Settings
    </div>
  </nav>

  <button class="fab" id="fab">
    <svg width="30" height="30" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
  </button>
</div>

<script>
/* PWA registration */
if('serviceWorker' in navigator){ addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js')); }

/* Utility */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const todayText = new Date().toLocaleDateString(undefined, {weekday:"long", year:"numeric", month:"long", day:"numeric"});
$("#today").textContent = todayText;
function isoDay(d){ const x = new Date(d.getTime() - d.getTimezoneOffset()*60000); return x.toISOString().slice(0,10); }
function vibrate(ms=35){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){} }

/* Background grid */
(function(){
  const c = document.getElementById('bg'); if(!c) return;
  const ctx = c.getContext('2d'); const DPR = Math.max(1, devicePixelRatio||1);
  function size(){ c.width = c.clientWidth*DPR; c.height = c.clientHeight*DPR; }
  size(); addEventListener('resize', size);
  let t=0;
  function draw(){
    const {width:w, height:h} = c; ctx.clearRect(0,0,w,h);
    ctx.lineWidth = 1*DPR; ctx.strokeStyle = 'rgba(255,255,255,0.065)';
    const gap = 40*DPR, off = (t%gap);
    for(let x=-off; x<w; x+=gap){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for(let y=-off; y<h; y+=gap){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
    t += .35*DPR; requestAnimationFrame(draw);
  }
  draw();
})();

/* Data store */
const STORE = "coachlite_ui_v1";
const S = load() || { prefs:{goal:"hypertrophy", minutes:45, split:"push", equipment:"full", level:"intermediate"}, today:{date:isoDay(new Date()), plan:[], done:[]}, lifts:{}, logs:[] };
save();
function load(){ try{ return JSON.parse(localStorage.getItem(STORE)); }catch(e){ return null; } }
function save(){ localStorage.setItem(STORE, JSON.stringify(S)); }

/* Library */
function AMRAP(){ return "AMRAP"; }
const LIB = [
  ["Back squat","compound","barbell",["legs","squat","lower"],{strength:[5,5],hypertrophy:[4,8],fatloss:[3,12]}],
  ["Front squat","compound","barbell",["legs","squat","lower"],{strength:[5,5],hypertrophy:[4,8],fatloss:[3,12]}],
  ["Deadlift","compound","barbell",["pull","hinge","lower"],{strength:[5,3],hypertrophy:[4,6],fatloss:[3,10]}],
  ["Romanian deadlift","compound","barbell",["pull","hinge","lower"],{strength:[5,5],hypertrophy:[4,8],fatloss:[3,12]}],
  ["Bench press","compound","barbell",["push","chest","upper"],{strength:[5,5],hypertrophy:[4,8],fatloss:[3,12]}],
  ["Incline DB press","accessory","dumbbell",["push","chest","upper"],{strength:[4,6],hypertrophy:[4,10],fatloss:[3,12]}],
  ["Overhead press","compound","barbell",["push","shoulders","upper"],{strength:[5,5],hypertrophy:[4,8],fatloss:[3,12]}],
  ["Pull up","compound","body",["pull","lats","upper"],{strength:[5,5],hypertrophy:[4,8],fatloss:[4,AMRAP()]}],
  ["Barbell row","accessory","barbell",["pull","back","upper"],{strength:[5,5],hypertrophy:[4,8],fatloss:[3,12]}],
  ["Seated cable row","accessory","machine",["pull","back","upper"],{strength:[4,6],hypertrophy:[4,10],fatloss:[3,12]}],
  ["Lateral raise","accessory","dumbbell",["shoulders","upper"],{strength:[3,12],hypertrophy:[3,15],fatloss:[3,20]}],
  ["Triceps pushdown","accessory","machine",["triceps","upper"],{strength:[3,10],hypertrophy:[3,12],fatloss:[3,15]}],
  ["Biceps curl","accessory","dumbbell",["biceps","upper"],{strength:[3,10],hypertrophy:[3,12],fatloss:[3,15]}],
  ["Hip thrust","accessory","barbell",["glutes","lower"],{strength:[5,5],hypertrophy:[4,8],fatloss:[3,12]}],
  ["Leg press","accessory","machine",["legs","lower"],{strength:[4,6],hypertrophy:[4,10],fatloss:[3,15]}],
  ["Goblet squat","accessory","dumbbell",["legs","lower"],{strength:[4,8],hypertrophy:[4,12],fatloss:[3,15]}],
  ["Hanging leg raise","core","body",["core"],{strength:[4,8],hypertrophy:[4,12],fatloss:[3,15]}],
  ["Cable crunch","core","machine",["core"],{strength:[4,12],hypertrophy:[4,15],fatloss:[3,20]}],
  ["Plank","core","body",["core","timed"],{strength:[3,45],hypertrophy:[3,60],fatloss:[3,60]}],
  ["Burpee finisher","finisher","body",["metcon"],{strength:[1,20],hypertrophy:[1,30],fatloss:[1,40]}],
  ["Bike sprint finisher","finisher","machine",["metcon"],{strength:[6,20],hypertrophy:[8,20],fatloss:[10,20]}]
];

/* Build plan helpers and UI below */

function allowEquip(item, eq){
  const e = item[2];
  if(eq === "full") return true;
  if(eq === "dumbbells") return e === "dumbbell" || e === "body" || item[0] === "Goblet squat";
  if(eq === "home") return e === "body" || e === "bands" || item[0] === "Goblet squat";
  return true;
}
function matchSplit(item, split){
  const t = item[3];
  if(split === "full") return true;
  if(split === "push") return t.includes("push") || t.includes("chest") || t.includes("shoulders") || t.includes("triceps");
  if(split === "pull") return t.includes("pull") || t.includes("back") || t.includes("lats") || t.includes("biceps");
  if(split === "legs" || split === "lower") return t.includes("lower") || t.includes("legs");
  if(split === "upper") return t.includes("upper") || t.includes("push") || t.includes("pull");
  return true;
}
function pick(arr, n){ const out = [], pool = [...arr]; while(out.length < n && pool.length){ out.push(pool.splice(Math.floor(Math.random()*pool.length),1)[0]); } return out; }
function suggestWeight(name, reps){
  const last = S.lifts[name]?.last;
  if(last){
    const step = reps !== "AMRAP" && reps <= 6 ? 2.5 : 0;
    return Math.max(0, Math.round((last.weight + step) * 2) / 2);
  }
  return 0;
}
function makeBlock(item, goal, level, fin = false){
  const [name, type, eq, tags, def] = item;
  const [sets, reps] = def[goal];
  const rest = type === "compound" ? 120 : fin ? 30 : 75;
  const rpe = level === "new" ? 7 : level === "intermediate" ? 8 : 9;
  return { name, type, eq, tags, sets, reps, rest, rpe, weight: suggestWeight(name, reps), fin, setReps:{}, setRPE:{} };
}
function estimateTime(b){
  if(b.fin) return Math.max(6, Math.round(b.sets * (b.reps/20 + b.rest/60)));
  return Math.round(b.sets * (40/60) + (b.sets - 1) * (b.rest/60)) + 2;
}
function buildSession(){
  const {goal, minutes, split, equipment, level} = S.prefs;
  const comp = LIB.filter(x => x[1] === "compound" && allowEquip(x, equipment) && matchSplit(x, split));
  const acc  = LIB.filter(x => x[1] === "accessory" && allowEquip(x, equipment) && matchSplit(x, split));
  const core = LIB.filter(x => x[1] === "core" && allowEquip(x, equipment));
  const fin  = LIB.filter(x => x[1] === "finisher" && allowEquip(x, equipment));

  const plan = [];
  pick(comp, Math.min(2, comp.length)).forEach(c => plan.push(makeBlock(c, S.prefs.goal, S.prefs.level)));
  pick(acc,  Math.min(2, acc.length)).forEach(a => plan.push(makeBlock(a, S.prefs.goal, S.prefs.level)));
  const c = pick(core, 1)[0]; if(c) plan.push(makeBlock(c, S.prefs.goal, S.prefs.level));
  if(S.prefs.goal !== "strength" && minutes >= 35 && fin.length){
    plan.push(makeBlock(pick(fin, 1)[0], S.prefs.goal, S.prefs.level, true));
  }
  // time trim
  let mins = plan.reduce((m,b)=>m+estimateTime(b), 0);
  while(mins > minutes && plan.length > 3){ plan.pop(); mins = plan.reduce((m,b)=>m+estimateTime(b), 0); }
  $("#estTime").textContent = mins + " minutes";
  return plan;
}

/* Render the plan list */
function renderPlan(){
  const list = $("#planList"); list.innerHTML = "";
  if(!S.today.plan.length){ $("#estTime").textContent = "0 minutes"; return; }
  let mins = 0;
  S.today.plan.forEach((b, i)=>{
    mins += estimateTime(b);
    const card = document.createElement("div"); card.className = "ex";
    card.innerHTML = `
      <div class="ico">${iconFor(b)}</div>
      <div>
        <h3>${b.name}</h3>
        <div class="tags">
          <span class="tag">${b.type}</span>
          <span class="tag">${b.reps==="AMRAP" ? "AMRAP" : `${b.sets} Ã— ${b.reps}`}</span>
          <span class="tag">Rest ${b.rest}s</span>
          <span class="tag">RPE ${b.rpe}</span>
        </div>
      </div>
      <div class="row" style="flex-direction:column; gap:8px">
        <input type="number" step="0.5" value="${b.weight||0}" data-w="${i}" title="Weight" style="width:90px" />
        <button class="btn" data-swap="${i}">Swap</button>
      </div>`;
    list.appendChild(card);
  });
  $("#estTime").textContent = mins + " minutes";

  $$("input[data-w]").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const i = +inp.dataset.w;
      S.today.plan[i].weight = parseFloat(e.target.value || 0);
      save();
    });
  });
  $$("button[data-swap]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.dataset.swap;
      const cur = S.today.plan[i];
      const pool = LIB.filter(x => x[1] === cur.type && allowEquip(x, S.prefs.equipment) && matchSplit(x, S.prefs.split) && x[0] !== cur.name);
      if(!pool.length) return;
      S.today.plan[i] = makeBlock(pool[Math.floor(Math.random()*pool.length)], S.prefs.goal, S.prefs.level, cur.fin);
      save(); renderPlan();
    });
  });
}
function iconFor(b){
  const m = {
    squat:'<svg viewBox="0 0 24 24"><path d="M4 19h16M7 16l3-6 4 6" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="14" cy="6" r="2" fill="currentColor"/></svg>',
    push:'<svg viewBox="0 0 24 24"><path d="M4 12h16M12 4v16" stroke="currentColor" stroke-width="2"/></svg>',
    pull:'<svg viewBox="0 0 24 24"><path d="M4 6h16M8 6v12M16 6v12" stroke="currentColor" stroke-width="2"/></svg>',
    core:'<svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="3" stroke="currentColor" stroke-width="2" fill="none"/><path d="M6 12h12" stroke="currentColor" stroke-width="2"/></svg>',
    metcon:'<svg viewBox="0 0 24 24"><path d="M4 12a8 8 0 1 1 16 0" stroke="currentColor" stroke-width="2" fill="none"/><path d="M8 22h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>'
  };
  if(b.tags.includes("squat")) return m.squat;
  if(b.tags.includes("push")) return m.push;
  if(b.tags.includes("pull")) return m.pull;
  if(b.tags.includes("core")) return m.core;
  return m.metcon;
}

/* Form controls */
$("#goal").value = S.prefs.goal;
$("#minutes").value = S.prefs.minutes;
$("#split").value = S.prefs.split;
$("#equipment").value = S.prefs.equipment;
$("#level").value = S.prefs.level;

$("#buildBtn").onclick = ()=>{
  S.prefs.goal = $("#goal").value;
  S.prefs.minutes = +$("#minutes").value;
  S.prefs.split = $("#split").value;
  S.prefs.equipment = $("#equipment").value;
  S.prefs.level = $("#level").value;
  S.today = {date: isoDay(new Date()), plan: buildSession(), done: []};
  save(); renderPlan(); vibrate(20);
};
$("#quickBtn").onclick = ()=>{
  S.today = {date: isoDay(new Date()), plan: buildSession(), done: []};
  save(); renderPlan(); vibrate(15);
};
$("#shuffleBtn").onclick = ()=>{
  if(!S.today.plan.length) return;
  S.today.plan.sort(()=>Math.random()-.5);
  save(); renderPlan();
};
$("#startBtn").onclick = ()=>{
  if(!S.today.plan.length) return;
  openRunner(0);
};
$("#fab").onclick = ()=>{ $("#buildBtn").click(); };

/* Navigation */
const views = ["view-plan","view-workout","view-settings"];
$$(".nav .tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    const to = tab.dataset.to;
    views.forEach(id => $("#"+id).classList.remove("active"));
    $("#"+to).classList.add("active");
    $$(".nav .tab").forEach(t => t.classList.toggle("active", t === tab));
  });
});

/* Runner */
let timer = null, left = 60, ringLen = 339.292, curIdx = 0;
function setClock(sec){ left = sec; renderClock(); }
function renderClock(){
  const m = String(Math.floor(left/60)).padStart(2,"0");
  const s = String(left%60).padStart(2,"0");
  $("#timeText").textContent = `${m}:${s}`;
  const p = 1 - (left / Math.max(1, parseInt($("#restLen").value,10)));
  $("#ringProg").setAttribute("stroke-dashoffset", String(ringLen * p));
}
function tick(){ left -= 1; if(left <= 0){ clearInterval(timer); timer = null; vibrate(50); } renderClock(); }

function openRunner(i){
  curIdx = i;
  const b = S.today.plan[i]; if(!b) return;
  $("#runName").textContent = `${b.name} â€¢ ${b.reps==="AMRAP" ? "AMRAP" : b.sets + " Ã— " + b.reps}`;
  const list = $("#setList"); list.innerHTML = "";
  for(let s=0; s<b.sets; s++){
    const reps = b.setReps[s] ?? (b.reps==="AMRAP" ? 0 : b.reps);
    const rpe  = b.setRPE[s]  ?? b.rpe;
    const row = document.createElement("div"); row.className = "setrow";
    row.innerHTML = `
      <span class="pill">Set ${s+1}</span>
      <label>Reps <input type="number" min="1" value="${reps}" data-r="${i}:${s}" /></label>
      <label>RPE <input type="number" min="5" max="10" step="0.5" value="${rpe}" data-e="${i}:${s}" /></label>
      <button class="btn primary" data-m="${i}:${s}">Mark</button>`;
    list.appendChild(row);
  }
  list.querySelectorAll('input[data-r]').forEach(inp=>{
    inp.addEventListener('input', e=>{ const [ii,ss]=inp.dataset.r.split(":").map(Number); S.today.plan[ii].setReps[ss] = parseInt(e.target.value||0,10); save(); });
  });
  list.querySelectorAll('input[data-e]').forEach(inp=>{
    inp.addEventListener('input', e=>{ const [ii,ss]=inp.dataset.e.split(":").map(Number); S.today.plan[ii].setRPE[ss] = parseFloat(e.target.value||0); save(); });
  });
  list.querySelectorAll('button[data-m]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const [ii,ss] = btn.dataset.m.split(":").map(Number);
      const blk = S.today.plan[ii];
      const reps = blk.setReps[ss] ?? (blk.reps==="AMRAP" ? 0 : blk.reps);
      const weight = blk.weight || 0;
      const vol = weight * reps;
      const d = isoDay(new Date());
      S.lifts[blk.name] = S.lifts[blk.name] || {last:{}, history:[]};
      S.lifts[blk.name].last = {weight, reps, sets: blk.sets};
      const prevTop = (S.lifts[blk.name].history||[]).reduce((m,x)=>Math.max(m, x.vol), 0);
      S.lifts[blk.name].history.push({d, vol, pr: vol > prevTop});
      S.today.done.push({i:ss, t:Date.now()});
      save();
      btn.textContent = "Done"; btn.disabled = true; vibrate(30);
      setClock(parseInt($("#restLen").value,10)); startTimer();
    });
  });
  $("#runner").classList.add("show");
  setClock(parseInt($("#restLen").value,10));
}
function closeRunner(){ $("#runner").classList.remove("show"); if(timer){ clearInterval(timer); timer = null; } }
$("#closeRun").onclick = closeRunner;
$("#startRest").onclick = ()=>{ if(timer) return; startTimer(); };
$("#pauseRest").onclick = ()=>{ if(timer){ clearInterval(timer); timer = null; } };
$("#resetRest").onclick = ()=>{ if(timer){ clearInterval(timer); timer = null; } setClock(parseInt($("#restLen").value,10)); };
function startTimer(){ timer = setInterval(tick, 1000); }

/* Progress view */
function drawChart(){
  const c = $("#chart"); const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const days = [...Array(7)].map((_,i)=>{ const d=new Date(); d.setDate(d.getDate()-6+i); return isoDay(d); });
  const totals = {};
  Object.values(S.lifts).forEach(L=> L.history.forEach(h=> totals[h.d] = (totals[h.d]||0) + h.vol));
  const vals = days.map(d=> totals[d]||0);
  const w=c.width, h=c.height, pad=28, slot=(w-pad*2)/7, barW=slot*.6, max=Math.max(10,...vals);
  days.forEach((d,i)=>{
    const x=pad+i*slot+(slot-barW)/2, y=h-pad, bh=Math.round((vals[i]/max)*(h-pad*2));
    ctx.fillStyle = vals[i] ? "#6ee7b7" : "rgba(255,255,255,.08)";
    ctx.fillRect(x, y-bh, barW, bh);
    ctx.fillStyle="#96a3b6"; ctx.font="12px ui-monospace, monospace";
    const lb=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"][i]; ctx.fillText(lb, x+barW/2-10, h-8);
  });
  const prs=[]; Object.entries(S.lifts).forEach(([name,v])=>{ const last=v.history[v.history.length-1]; if(last?.pr) prs.push(name); });
  $("#prs").textContent = prs.length ? "New PRs: " + prs.join(", ") : "No new PRs today";
}
function renderHistory(){
  const wrap = $("#history"); wrap.innerHTML = "";
  const days = {};
  Object.values(S.lifts).forEach(L=> L.history.forEach(h=> { (days[h.d] = days[h.d] || []).push(h); }));
  Object.keys(days).sort().reverse().slice(0,7).forEach(d=>{
    const total = days[d].reduce((m,x)=>m+x.vol,0).toFixed(0);
    const card = document.createElement("div"); card.className = "ex";
    card.innerHTML = `<div class="ico"></div><div><h3>${d}</h3><div class="tags"><span class="tag">Volume ${total}</span></div></div>`;
    wrap.appendChild(card);
  });
}

/* Export */
$("#exportBtn").onclick = ()=>{
  const d = new Date().toISOString().slice(0,10);
  const lines = [];
  lines.push(`# Coach Lite â€” ${d}`,"");
  lines.push(`Goal: ${S.prefs.goal} â€¢ Split: ${S.prefs.split} â€¢ Equipment: ${S.prefs.equipment}`,"");
  S.today.plan.forEach(b=>{
    const w = b.weight || 0;
    lines.push(`- ${b.name}: ${b.reps==="AMRAP" ? `${b.sets} Ã— AMRAP` : `${b.sets} Ã— ${b.reps}`} @ ${w} kg, Rest ${b.rest}s, RPE ${b.rpe}`);
  });
  const blob = new Blob([lines.join("\n")], {type:"text/markdown"});
  const url = URL.createObjectURL(blob); const a = document.createElement("a");
  a.href = url; a.download = `coach-${d}.md`; a.click(); URL.revokeObjectURL(url);
};

/* Settings */
$("#resetToday").onclick = ()=>{ S.today = {date: isoDay(new Date()), plan: [], done: []}; save(); renderPlan(); vibrate(20); };
$("#clearAll").onclick = ()=>{ if(confirm("Clear all local data")){ localStorage.removeItem(STORE); location.reload(); } };

/* Init */
function init(){
  if(!S.today.plan.length) S.today.plan = buildSession();
  renderPlan(); drawChart(); renderHistory();
}
init();
</script>
</body>
</html>
